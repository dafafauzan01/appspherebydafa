<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">Detail Produk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* === KUNCI TAMPILAN (HP VIEW) === */
        body { background-color: #000; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
        #mobile-frame { width: 100%; max-width: 480px; background-color: #0a0e17; min-height: 100vh; box-shadow: 0 0 20px rgba(79, 172, 254, 0.1); color: #e0e6ed; }

        /* HEADER Detail */
        .app-header-detail { background: #131a2a; padding: 15px 20px; border-bottom: 1px solid #1c263d; display: flex; align-items: center; }
        .product-image { width: 100%; height: 250px; object-fit: cover; }
        
        /* Product Info */
        .product-info-container { padding: 20px; }
        .product-title { font-size: 24px; font-weight: bold; color: #fff; margin-top: 10px; }
        .stats-badge { background: #1c263d; color: #4facfe; padding: 5px 10px; border-radius: 8px; font-size: 12px; margin-right: 8px; }

        /* Variant List */
        .variant-item { padding: 15px; border: 1px solid #2a3a5a; margin-bottom: 10px; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #131a2a; transition: 0.2s; }
        .variant-item.selected { border-color: #4facfe; background: rgba(79,172,254,0.1); }
        .variant-item.disabled { opacity: 0.5; cursor: not-allowed; border-color: #444; }
        .variant-name { font-weight: bold; font-size: 14px; }
        .variant-price { font-weight: bold; color: #4facfe; font-size: 14px; }
        .variant-stok { font-size: 11px; color: #64748b; }

        /* Button & Form */
        .btn-primary-custom { background: linear-gradient(90deg, #4facfe, #00f2fe); border: none; color: #000; font-weight: bold; width: 100%; padding: 12px; border-radius: 12px; }
        .form-control-dark { background: #1c263d; border: 1px solid #2a3a5a; color: #fff; }

        /* Modal Overrides */
        .modal-content { background: #131a2a; color: #fff; border: 1px solid #2a3a5a; }
        .alert-primary { background-color: rgba(79, 172, 254, 0.1); border-color: #4facfe; color: #4facfe; }

    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyB-cU3n9GQiO5dyaXgLF3mwGFPZ6ACqQds",
          authDomain: "appsphere-de73d.firebaseapp.com",
          databaseURL: "https://appsphere-de73d-default-rtdb.firebaseio.com",
          projectId: "appsphere-de73d",
          storageBucket: "appsphere-de73d.firebasestorage.app",
          messagingSenderId: "610562583858",
          appId: "1:610562583858:web:7e252865c692af00783b2b",
          measurementId: "G-84ZR60FM03"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('produk');
    </script>
</head>
<body class="pb-5">
    <div id="mobile-frame">
        <div class="app-header-detail">
            <button onclick="window.history.back()" class="btn text-white me-3"><i class="fas fa-arrow-left fa-lg"></i></button>
            <h6 class="mb-0 fw-bold">Detail Produk</h6>
        </div>

        <div id="loading" class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-3">Memuat produk...</p></div>

        <div id="productContent" style="display: none;">
            <img id="dImg" src="" class="product-image" onerror="this.src='https://via.placeholder.com/480x250?text=AppSphere'">
            
            <div class="product-info-container">
                <div class="d-flex justify-content-start mb-3">
                    <span id="dKat" class="stats-badge"></span>
                    <span class="stats-badge"><i class="fas fa-eye me-1"></i> 2268</span>
                    <span class="stats-badge"><i class="fas fa-check-circle me-1"></i> 74</span>
                </div>
                
                <h1 id="dNama" class="product-title"></h1>
                <p class="text-muted small"> Stok akan diamankan setelah konfirmasi pembayaran.</p>

                <div class="mt-4">
                    <h5 class="text-white fw-bold mb-3">Pilih Varian</h5>
                    <div id="listVarian">
                        <div class="text-center text-muted small">Varian tidak ditemukan.</div>
                    </div>
                </div>

                <div class="mt-5 pt-3 border-top border-secondary">
                    <button id="btnLanjutBayar" class="btn btn-primary-custom disabled">LANJUT BAYAR</button>
                </div>

            </div>
        </div>

    </div> 

    <div class="modal fade" id="modalBayar" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h6 class="fw-bold mb-0">Pembayaran</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center pt-0"><div class="alert alert-primary py-1 px-2 d-inline-block small mb-3"><i class="fas fa-clock"></i> <span id="countdown">10:00</span></div><div class="bg-white p-2 rounded mb-3 mx-auto" style="width: 180px;"><img src="qris.jpg" class="img-fluid" onerror="this.src='https://via.placeholder.com/200?text=QRIS'"></div><h4 class="fw-bold text-primary mb-3" id="qTotal">Rp 0</h4><div class="text-start bg-dark p-3 rounded border border-secondary"><input type="text" id="inputNama" class="form-control form-control-dark mb-2 form-control-sm" placeholder="Nama Kamu"><input type="number" id="inputWA" class="form-control form-control-dark mb-2 form-control-sm" placeholder="Nomor WA"><textarea id="inputCatatan" class="form-control form-control-dark form-control-sm" rows="2" placeholder="Catatan (Email/Akun)" style="display:none;"></textarea></div><button onclick="tandaiLunas()" class="btn btn-primary-custom mt-3">KONFIRMASI BAYAR</button></div></div></div></div>

    <div class="modal fade" id="modalSukses" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><i class="fas fa-check-circle text-success mb-3" style="font-size: 50px;"></i><h5 class="fw-bold">Pesanan Dibuat!</h5><p class="small text-muted mb-3">Stok berhasil diamankan.</p><div class="bg-dark p-2 rounded text-start small mb-3 border border-secondary"><div>ID: <span id="sId" class="text-info"></span></div><div>Item: <span id="sProduk"></span></div><div>Varian: <span id="sVarian" class="text-warning"></span></div></div><button onclick="kirimWA()" class="btn btn-success w-100 fw-bold mb-2"><i class="fab fa-whatsapp me-2"></i>KIRIM BUKTI</button><button onclick="window.history.back()" class="btn btn-outline-secondary w-100 btn-sm">Tutup</button></div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const NOMOR_WA = "6283843400022";
        let produkAktif, varianPilihan, timerInterval, trxData = {};
        let modalBayarInstance, modalSuksesInstance;

        window.onload = () => {
            modalBayarInstance = new bootstrap.Modal(document.getElementById('modalBayar'));
            modalSuksesInstance = new bootstrap.Modal(document.getElementById('modalSukses'));
            document.getElementById('btnLanjutBayar').addEventListener('click', bukaQRIS);
            loadProduct();
        };

        // Mengambil ID produk dari URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(window.location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };

        function loadProduct() {
            const productId = getUrlParameter('id');
            const loadingElement = document.getElementById('loading');
            const productContentElement = document.getElementById('productContent');
            
            if (!productId) {
                loadingElement.innerHTML = '<h5 class="text-danger">ID Produk tidak ditemukan.</h5><button onclick="window.history.back()" class="btn btn-primary mt-3">Kembali</button>';
                return;
            }

            // Koneksi Firebase untuk mengambil satu produk
            dbRef.child(productId).once('value', (snapshot) => {
                produkAktif = snapshot.val();
                
                if (!produkAktif) {
                    loadingElement.innerHTML = '<h5 class="text-danger">Produk tidak ada dalam database.</h5><button onclick="window.history.back()" class="btn btn-primary mt-3">Kembali</button>';
                    return;
                }
                
                // Render data ke elemen HTML
                document.getElementById('pageTitle').innerText = produkAktif.nama;
                document.getElementById('dImg').src = produkAktif.img;
                document.getElementById('dNama').innerText = produkAktif.nama;
                document.getElementById('dKat').innerText = produkAktif.kat;
                
                renderVarian();
                loadingElement.style.display = 'none';
                productContentElement.style.display = 'block';
            }, (errorObject) => {
                 // Handle error jika koneksi Firebase gagal
                 loadingElement.innerHTML = `<h5 class="text-danger">Gagal memuat data: ${errorObject.code}</h5><button onclick="window.history.back()" class="btn btn-primary mt-3">Kembali</button>`;
            });
        }

        function renderVarian() {
            let h = "";
            let list = document.getElementById('listVarian');
            if(produkAktif.varian) produkAktif.varian.forEach((v, x) => {
                let stok = v.stok !== undefined ? v.stok : 99;
                let habis = stok <= 0;
                let stokText = habis ? 'Stok Habis' : `Stok: ${stok}`;
                let stokColor = habis ? 'text-danger' : 'text-success';

                h += `
                <div class="variant-item ${habis ? 'disabled' : ''}" data-index="${x}" onclick="${habis ? '' : `pilihVarian(${x}, this)`}">
                    <div>
                        <div class="variant-name">${v.nama}</div>
                        <div class="variant-stok ${stokColor}">${stokText}</div>
                    </div>
                    <div class="variant-price">Rp ${parseInt(v.harga).toLocaleString()}</div>
                </div>
                `;
            });
            list.innerHTML = h || '<div class="text-center text-muted small">Varian tidak ditemukan.</div>';
        }

        function pilihVarian(x, el) {
            document.querySelectorAll('.variant-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            varianPilihan = { ...produkAktif.varian[x], index: x };
            document.getElementById('btnLanjutBayar').classList.remove('disabled');

            document.querySelectorAll('.desc-box-dynamic').forEach(e => e.remove());

            if(varianPilihan.desk && varianPilihan.desk !== "-" && varianPilihan.desk !== "undefined") { 
                el.insertAdjacentHTML('afterend', `<div class="desc-box-dynamic alert alert-primary small mt-2 mb-3">${varianPilihan.desk}</div>`); 
            }
        }

        function bukaQRIS() {
            if(!varianPilihan) return alert("Pilih varian dulu!");

            document.getElementById('qTotal').innerText = "Rp " + parseInt(varianPilihan.harga).toLocaleString();
            document.getElementById('inputNama').value = ""; document.getElementById('inputWA').value = "";
            
            let cat = document.getElementById('inputCatatan'); 
            cat.value = ""; 
            cat.style.display = (produkAktif.formType === 'lengkap') ? 'block' : 'none';

            let d = 600; clearInterval(timerInterval);
            timerInterval = setInterval(() => { 
                let m = Math.floor(d/60), s = d%60; 
                document.getElementById('countdown').innerText = `${m}:${s<10?'0':''}${s}`; 
                if(--d < 0) { 
                    clearInterval(timerInterval); 
                    modalBayarInstance.hide(); 
                    alert('Waktu Pembayaran Habis. Silakan coba lagi.'); 
                } 
            }, 1000);
            modalBayarInstance.show();
        }

        function tandaiLunas() {
            let n = document.getElementById('inputNama').value, w = document.getElementById('inputWA').value;
            if(!n || !w) return alert("Nama & WA Wajib!");
            
            let stokPath = `produk/${produkAktif.id}/varian/${varianPilihan.index}/stok`;
            firebase.database().ref(stokPath).transaction((currentStok) => {
                if (currentStok === null) return 0;
                return currentStok - 1;
            });

            clearInterval(timerInterval);
            trxData = { 
                id: 'TRX-'+Math.floor(Math.random()*100000), 
                produk: produkAktif.nama, 
                varian: varianPilihan.nama, 
                harga: "Rp "+parseInt(varianPilihan.harga).toLocaleString(), 
                nama: n, 
                wa: w, 
                cat: document.getElementById('inputCatatan').value || "-" 
            };

            document.getElementById('sId').innerText = trxData.id;
            document.getElementById('sProduk').innerText = trxData.produk;
            document.getElementById('sVarian').innerText = trxData.varian;
            
            modalBayarInstance.hide(); 
            modalSuksesInstance.show();
        }

        function kirimWA() {
            let t = `Halo Admin, saya order via Web.%0A%0A*ID:* ${trxData.id}%0A*Nama:* ${trxData.nama}%0A*Item:* ${trxData.produk}%0A*Varian:* ${trxData.varian}%0A*Total:* ${trxData.harga}%0A*Catatan:* ${trxData.cat}%0A%0A*Saya sudah Transfer QRIS.* Mohon dicek.`;
            window.open(`https://wa.me/${NOMOR_WA}?text=${t}`, '_blank');
        }
    </script>
</body>
</html>

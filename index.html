<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppSphere Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* BACKGROUND & FONT UTAMA (TEMA BIRU) */
        body { background-color: #0a0e17; color: #e0e6ed; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; background-image: radial-gradient(circle at top center, #1a2235 0%, #0a0e17 70%); }
        
        /* HEADER BIRU */
        .app-header { background: rgba(10, 14, 23, 0.9); backdrop-filter: blur(15px); padding: 15px 0; border-bottom: 1px solid #1c263d; position: sticky; top: 0; z-index: 1000; }
        .logo-text { font-size: 24px; font-weight: 800; background: linear-gradient(45deg, #4facfe, #a6c1ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; text-decoration: none; display: block; text-shadow: 0 0 20px rgba(79, 172, 254, 0.3); margin-bottom: 5px; }
        
        /* SEARCH BOX (BIRU + TEKS PUTIH) */
        .search-box { background: #131a2a; border: 1px solid #2a3a5a; border-radius: 50px; color: #fff; padding: 12px 45px 12px 20px; width: 100%; outline: none; transition: 0.3s; font-size: 14px; }
        .search-box:focus { border-color: #4facfe; box-shadow: 0 0 15px rgba(79, 172, 254, 0.3); }
        .search-box::placeholder { color: #a0aec0; } /* Placeholder Abu Terang */

        /* BANNER AREA */
        .hero-banner { width: 100%; height: 180px; object-fit: cover; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); border: 1px solid #1c263d; }

        /* CARD PRODUK */
        .card-product { border: 1px solid #1c263d; border-radius: 15px; background: #131a2a; color: white; cursor: pointer; transition: 0.3s; height: 100%; overflow: hidden; position: relative; }
        .card-product:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(79, 172, 254, 0.2); border: 1px solid #4facfe; }
        .product-img { height: 140px; width: 100%; object-fit: cover; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .card-price { font-size: 13px; font-weight: bold; color: #4facfe; }

        /* TOMBOL KATEGORI */
        .filter-scroll { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .btn-filter { border-radius: 25px; border: 1px solid #2a3a5a; background: #131a2a; color: #a0aec0; padding: 8px 20px; margin-right: 8px; font-size: 13px; transition: 0.3s; }
        .btn-filter.active, .btn-filter:hover { background: linear-gradient(45deg, #4facfe, #00f2fe); color: #fff; border: none; font-weight: bold; transform: scale(1.05); box-shadow: 0 0 15px rgba(79, 172, 254, 0.4); }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #0a0e17; border-top: 1px solid #1c263d; display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); }
        .nav-item { text-align: center; color: #718096; font-size: 11px; text-decoration: none; width: 33%; cursor: pointer; transition: 0.2s; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: #4facfe; text-shadow: 0 0 10px rgba(79, 172, 254, 0.5); }

        /* INPUT FORM (FIX WARNA PUTIH DI TEMA BIRU) */
        .form-label-custom { font-size: 12px; color: #a0aec0; margin-bottom: 4px; display: block; font-weight: bold; }
        .form-control-dark { 
            background: #1c263d !important; 
            border: 1px solid #2a3a5a !important; 
            color: #ffffff !important; /* Teks Ketikan Putih */
            border-radius: 8px; 
            padding: 10px; 
        }
        .form-control-dark:focus { border-color: #4facfe !important; box-shadow: 0 0 10px rgba(79, 172, 254, 0.2) !important; }
        
        /* Placeholder Abu Terang (Biar Kelihatan) */
        .form-control-dark::placeholder { 
            color: #a0aec0 !important; 
            opacity: 1; 
        }

        /* MODAL & BUTTONS */
        .modal-content { background-color: #131a2a; color: white; border: 1px solid #2a3a5a; border-radius: 15px; }
        .btn-blue-gradient { background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; color: white; font-weight: bold; }
        .btn-blue-gradient:hover { background: linear-gradient(45deg, #00f2fe, #4facfe); box-shadow: 0 0 15px rgba(79, 172, 254, 0.4); color: white; }
        
        /* VARIAN & LAINNYA */
        .variant-option { border: 1px solid #2a3a5a; border-radius: 12px; padding: 15px; margin-bottom: 10px; cursor: pointer; background: #1c263d; color: white; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .variant-option.selected { border: 1px solid #4facfe; background: #131a2a; box-shadow: 0 0 15px rgba(79, 172, 254, 0.2); }
        .desc-box-dynamic { background: #1c263d; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 12px; border-left: 3px solid #4facfe; }
        .timer-box { background: rgba(79, 172, 254, 0.1); color: #4facfe; padding: 8px; border-radius: 5px; text-align: center; font-weight: bold; border: 1px dashed #4facfe; margin-bottom: 15px; }
        
        /* CARA ORDER */
        .step-item { display: flex; align-items: center; margin-bottom: 15px; background: #1c263d; padding: 15px; border-radius: 12px; border: 1px solid #2a3a5a; }
        .step-icon { width: 45px; height: 45px; background: linear-gradient(45deg, #4facfe, #00f2fe); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; margin-right: 15px; flex-shrink: 0; box-shadow: 0 0 10px rgba(79, 172, 254, 0.3); }
        .step-text { font-size: 14px; color: #e0e6ed; text-align: left; }
    </style>
</head>
<body>

    <div class="app-header shadow-sm">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div><a href="index.html" class="logo-text"><i class="fas fa-globe-asia me-2"></i>AppSphere</a></div>
                <a href="login.html" class="text-secondary"><i class="fas fa-user-circle fa-2x"></i></a>
            </div>
            <div class="position-relative mt-2">
                <input type="text" id="searchInput" class="search-box" placeholder="Cari aplikasi premium..." onkeyup="cariProduk()">
                <i class="fas fa-search position-absolute" style="right: 15px; top: 12px; color: #4facfe;"></i>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <img src="banner.png" class="hero-banner mb-4" alt="Promo Banner" onerror="this.style.display='none'">

        <div class="filter-scroll mb-3">
            <button class="btn btn-filter active" onclick="filterProduk('Semua', this)">Semua</button>
            <button class="btn btn-filter" onclick="filterProduk('Streaming', this)">Streaming</button>
            <button class="btn btn-filter" onclick="filterProduk('Editing', this)">Editing</button>
            <button class="btn btn-filter" onclick="filterProduk('AI Tools', this)">AI Tools</button>
            <button class="btn btn-filter" onclick="filterProduk('Utility', this)">Utility</button>
            <button class="btn btn-filter" onclick="filterProduk('Productivity', this)">Productivity</button>
            <button class="btn btn-filter" onclick="filterProduk('Sosmed', this)">Sosmed</button>
            <button class="btn btn-filter" onclick="filterProduk('VPN', this)">VPN</button>
        </div>

        <div class="row g-3" id="areaProduk"></div>
        <div id="msgKosong" class="text-center mt-5 text-secondary" style="display:none;">
            <i class="fas fa-search fa-3x mb-3" style="color: #2a3a5a;"></i><br>Produk tidak ditemukan.
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="new bootstrap.Modal(document.getElementById('modalCaraOrder')).show()">
            <i class="fas fa-book-open"></i> <span>Cara Order</span>
        </div>
        <div class="nav-item active" onclick="location.reload()">
            <i class="fas fa-home"></i> <span>Home</span>
        </div>
        <a href="testimoni.html" class="nav-item text-decoration-none">
            <i class="fas fa-star"></i> <span>Testimoni</span>
        </a>
    </div>

    <div class="modal fade" id="modalCaraOrder" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold" style="color: #4facfe;"><i class="fas fa-info-circle me-2"></i>Cara Order</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-4">
                    <div class="step-item"><div class="step-icon"><i class="fas fa-hand-pointer"></i></div><div class="step-text"><b>1. Pilih Produk</b><br>Cari produk digital yang kamu inginkan.</div></div>
                    <div class="step-item"><div class="step-icon"><i class="fas fa-credit-card"></i></div><div class="step-text"><b>2. Isi Data & Bayar</b><br>Isi formulir dan scan QRIS.</div></div>
                    <div class="step-item"><div class="step-icon"><i class="fab fa-whatsapp"></i></div><div class="step-text"><b>3. Konfirmasi WA</b><br>Kirim bukti bayar ke Admin.</div></div>
                    <button class="btn btn-blue-gradient w-100 py-2 mt-3" data-bs-dismiss="modal">SIAP, SAYA MENGERTI! ðŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalVarian" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold" id="vNamaProduk">Nama Produk</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-4"><div id="listVarian"></div></div>
                <div class="modal-footer border-0 pt-0 align-items-center">
                    <div><small class="text-secondary d-block" style="font-size:10px;">Total Bayar</small><span id="vTotalHarga" class="fw-bold fs-5" style="color: #4facfe;">Rp 0</span></div>
                    <button id="btnLanjutBayar" class="btn btn-blue-gradient px-4 disabled" onclick="bukaQRIS()">LANJUT <i class="fas fa-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBayar" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h6 class="fw-bold">Pembayaran</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="timer-box"><i class="fas fa-clock me-1"></i> Selesaikan dalam <span id="countdown">10:00</span></div>
                    <img src="qris.jpg" class="img-fluid border border-2 border-primary rounded p-1 mb-3 bg-white" style="max-height: 200px;" onerror="this.src='https://via.placeholder.com/200?text=QRIS+NOT+FOUND'">
                    <h4 class="fw-bold mb-3" id="qTotal" style="color: #4facfe;">Rp 0</h4>
                    
                    <div class="text-start p-3 rounded border border-secondary mb-3" style="background: #1c263d;">
                        <h6 class="small fw-bold text-white mb-3 border-bottom pb-2 border-secondary" style="color: #4facfe !important;">DATA PEMBELI</h6>
                        <label class="form-label-custom">Nama Kamu</label>
                        <input type="text" id="inputNama" class="form-control form-control-dark mb-2" placeholder="Cth: Budi">
                        <label class="form-label-custom">Nomor WhatsApp</label>
                        <input type="number" id="inputWA" class="form-control form-control-dark mb-2" placeholder="08xxxxx">
                        <div id="divCatatan" style="display:none;">
                            <label class="form-label-custom" style="color: #4facfe;">Detail Order</label>
                            <textarea id="inputCatatan" class="form-control form-control-dark" rows="2" style="border-color: #4facfe !important;"></textarea>
                        </div>
                    </div>
                    <button onclick="tandaiLunas()" class="btn btn-blue-gradient w-100 py-2 shadow">SAYA SUDAH BAYAR <i class="fas fa-check-circle ms-1"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSukses" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content w-100 p-3 rounded border border-secondary" style="background: #0a0e17;">
                <div class="text-center mb-3 pt-2">
                    <i class="fas fa-check-circle" style="font-size: 60px; color: #4facfe;"></i>
                    <h5 class="fw-bold mt-3" style="color: #4facfe;">Pembayaran Berhasil!</h5>
                </div>
                <div class="p-3 rounded mb-3 border border-secondary" style="background: #131a2a;">
                    <div class="d-flex justify-content-between mb-1 small"><span>ID:</span> <span id="sId" style="color: #4facfe;">TRX-000</span></div>
                    <div class="d-flex justify-content-between mb-1 small"><span>Produk:</span> <span id="sProduk">-</span></div>
                    <div class="d-flex justify-content-between mb-1 small"><span>Paket:</span> <span id="sVarian">-</span></div>
                    <div class="d-flex justify-content-between mb-1 small"><span>Total:</span> <span id="sHarga" class="fw-bold text-white">-</span></div>
                    <div class="d-flex justify-content-between mb-1 small mt-2 pt-2 border-top border-secondary" id="rowCatatan" style="display:none;"><span>Catatan:</span> <span id="sCatatan" style="color: #4facfe;">-</span></div>
                </div>
                <button onclick="kirimWA()" class="btn btn-blue-gradient w-100 py-2 mb-2"><i class="fab fa-whatsapp me-1"></i> KIRIM BUKTI KE ADMIN</button>
                <button onclick="tutupBelanja()" class="btn btn-outline-blue w-100 btn-sm" style="border: 1px solid #4facfe; color: #4facfe;">Tutup</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        const NOMOR_WA = "6283843400022"; 

        // === FIREBASE CONFIG DARI SCREENSHOT KAMU ===
        const firebaseConfig = {
          apiKey: "AIzaSyB-cU3n9GQiO5dyaXgLF3mwGFPZ6ACqQds",
          authDomain: "appsphere-de73d.firebaseapp.com",
          projectId: "appsphere-de73d",
          storageBucket: "appsphere-de73d.firebasestorage.app",
          messagingSenderId: "610562583858",
          appId: "1:610562583858:web:7e252865c692af00783b2b",
          measurementId: "G-84ZR60FM03"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('produk');

        // LOGIKA BARU: DB ngambil dari Firebase, bukan LocalStorage
        let db = [];
        let produkAktif = null, varianPilihan = null, timerInterval;
        let modalVarianInstance, modalBayarInstance, modalSuksesInstance;
        let trxData = {};

        // INI FUNGSI FIREBASE BIAR OTOMATIS
        dbRef.on('value', (snapshot) => {
            const dataObj = snapshot.val();
            db = [];
            if (dataObj) {
                Object.keys(dataObj).forEach(key => {
                    db.push({ id: key, ...dataObj[key] });
                });
            }
            // Langsung render ulang kalo data berubah
            render('Semua');
        });

        window.onload = function() {
            modalVarianInstance = new bootstrap.Modal(document.getElementById('modalVarian'));
            modalBayarInstance = new bootstrap.Modal(document.getElementById('modalBayar'));
            modalSuksesInstance = new bootstrap.Modal(document.getElementById('modalSukses'));
            // render() akan dipanggil otomatis oleh Firebase di atas
        }

        // FUNGSI BAWAAN KAMU (GAK SAYA UBAH)
        function cariProduk() {
            let keyword = document.getElementById('searchInput').value.toLowerCase();
            let area = document.getElementById('areaProduk');
            area.innerHTML = '';
            let hasil = db.filter(p => p.nama.toLowerCase().includes(keyword));
            if(hasil.length === 0) document.getElementById('msgKosong').style.display = 'block';
            else { document.getElementById('msgKosong').style.display = 'none'; renderGrid(hasil); }
        }

        function render(kategori) {
            let data = (kategori === 'Semua') ? db : db.filter(p => p.kat === kategori);
            renderGrid(data);
        }

        function renderGrid(data) {
            let area = document.getElementById('areaProduk');
            area.innerHTML = '';
            if(data.length === 0) document.getElementById('msgKosong').style.display = 'block';
            else {
                document.getElementById('msgKosong').style.display = 'none';
                data.forEach((p, i) => {
                    // Cek ID Firebase atau index array
                    let realIndex = i; 
                    let hargaMulai = p.varian ? p.varian[0].harga : p.harga;
                    
                    // Kita oper index array 'i' dari hasil filter
                    // Tapi pas onclick harus tau ini produk yg mana di 'db' utama
                    // Cara gampang: oper object nya langsung atau cari index di db utama
                    let dbIndex = db.findIndex(x => x.id === p.id); // Cari index di db utama pake ID Firebase
                    if (dbIndex === -1) dbIndex = i; // Fallback

                    area.innerHTML += `
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="card card-product" onclick="cekProduk(${dbIndex})">
                                <img src="${p.img}" class="product-img" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate">${p.nama}</h6>
                                    <div class="card-price">Mulai Rp ${parseInt(hargaMulai).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>`;
                });
            }
        }

        function filterProduk(k, btn) {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render(k);
        }

        function cekProduk(index) {
            produkAktif = db[index];
            document.getElementById('vNamaProduk').innerText = produkAktif.nama;
            let listHTML = "";
            if(produkAktif.varian) {
         .product-price { font-size: 18px; font-weight: 800; color: #4facfe; margin-top: 5px; }
        
        /* FOOTER NAV */
        .app-footer { background: rgba(10, 14, 23, 0.95); backdrop-filter: blur(15px); border-top: 1px solid #1c263d; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 10px 0; }
        .nav-item-footer { color: #8a99b3; transition: color 0.2s; font-size: 12px; }
        .nav-item-footer i { font-size: 20px; margin-bottom: 3px; }
        .nav-item-footer:hover, .nav-item-footer.active { color: #4facfe; }

        /* MODAL */
        .modal-content { background: #131a2a; color: #e0e6ed; border-radius: 20px; border: 1px solid #1c263d; }
        .modal-header { border-bottom: 1px solid #1c263d; }
        .modal-footer { border-top: 1px solid #1c263d; }
        .variant-option { background: #1c263d; border: 1px solid #2a3a5a; border-radius: 10px; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .variant-option:hover { background: #2a3a5a; }
        .variant-option.selected { background: #4facfe; border-color: #4facfe; color: #0a0e17; font-weight: bold; box-shadow: 0 0 10px rgba(79, 172, 254, 0.5); }
        .desc-box-dynamic { background: #2a3a5a; border-left: 3px solid #4facfe; padding: 10px; margin-top: 5px; border-radius: 5px; font-size: 14px; color: #a6c1ee; }
        .btn-qris { background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; color: white; font-weight: bold; }
        .btn-qris:hover { background: linear-gradient(45deg, #00f2fe, #4facfe); }
        .qris-box { background: #0a0e17; padding: 15px; border-radius: 10px; border: 1px solid #1c263d; }
        .qris-timer { font-size: 18px; font-weight: bold; color: #4facfe; }
        .form-control, .form-select { background: #1c263d; border: 1px solid #2a3a5a; color: #ffffff; }
        .form-control:focus, .form-select:focus { background: #1c263d; border-color: #4facfe; color: #ffffff; box-shadow: 0 0 5px rgba(79, 172, 254, 0.3); }

        /* KOSONG */
        .empty-message { text-align: center; padding: 50px 0; color: #8a99b3; }
        .empty-message i { font-size: 40px; margin-bottom: 15px; color: #1c263d; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="logo-text">AppSphere</div>
        </div>
        <div class="container mt-3">
            <div class="search-container d-flex align-items-center">
                <i class="fas fa-search me-2 text-muted"></i>
                <input type="text" id="searchInput" onkeyup="cariProduk(this.value)" class="search-input flex-grow-1" placeholder="Cari Produk atau Jasa...">
            </div>
        </div>
    </header>

    <div class="container mt-3">
        <div class="category-nav" id="categoryNav">
            <div class="category-item active" onclick="filterProduk('Semua', this)">Semua</div>
        </div>
    </div>
    
    <main class="container my-4">
        <div id="msgKosong" class="empty-message" style="display: none;">
            <i class="fas fa-box-open"></i>
            <h5>Produk Kosong</h5>
            <p>Admin belum menambahkan produk apapun.</p>
        </div>
        <div class="row row-cols-2 row-cols-md-4 g-3" id="productGrid"></div>
    </main>

    <footer class="app-footer">
        <div class="container">
            <div class="row text-center">
                <div class="col"><a href="index.html" class="d-flex flex-column align-items-center nav-item-footer active"><i class="fas fa-store"></i><span>Toko</span></a></div>
                <div class="col"><a href="testimoni.html" class="d-flex flex-column align-items-center nav-item-footer"><i class="fas fa-images"></i><span>Bukti</span></a></div>
                <div class="col"><a href="login.html" class="d-flex flex-column align-items-center nav-item-footer"><i class="fas fa-user-shield"></i><span>Admin</span></a></div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="modalVarian" tabindex="-1" aria-labelledby="modalVarianLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVarianLabel">Pilih Varian Produk</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-2">Pilih salah satu varian di bawah:</p>
                    <div id="listVarian"></div>
                </div>
                <div class="modal-footer d-block">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Total Harga:</span>
                        <span class="fw-bold fs-5" id="vTotalHarga">Rp 0</span>
                    </div>
                    <button type="button" class="btn btn-qris w-100 disabled" id="btnLanjutBayar" onclick="bukaQRIS()">Lanjut Pembayaran <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBayar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalBayarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalBayarLabel">Selesaikan Transaksi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="batalkanTransaksi()"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="qris-box mb-3">
                        <img src="qris.jpg" class="img-fluid rounded mb-2" onerror="this.src='https://via.placeholder.com/200?text=QRIS+NOT+FOUND'">
                        <p class="mb-0 small text-muted">Scan QRIS di atas untuk pembayaran</p>
                    </div>
                    
                    <p class="mb-1">Waktu Pembayaran Tersisa:</p>
                    <h4 class="qris-timer mb-3" id="timer">00:00</h4>

                    <p class="fw-bold mb-1" id="qTotal">Total: Rp 0</p>
                    <p class="small text-warning" id="qDeadline"></p>

                    <hr>

                    <form id="formKonfirmasi">
                        <p class="small text-muted">Masukkan detail kamu untuk konfirmasi:</p>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="inputNama" placeholder="Nama Kamu" required>
                        </div>
                        <div class="mb-3">
                            <input type="number" class="form-control" id="inputWA" placeholder="Nomor WhatsApp (Contoh: 628xxxxxx)" required>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="inputCatatan" rows="2" placeholder="Catatan Tambahan (Opsional)"></textarea>
                        </div>
                        <button type="submit" class="btn btn-qris w-100">KONFIRMASI PEMBAYARAN <i class="fas fa-check-circle ms-2"></i></button>
                    </form>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSukses" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalSuksesLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success" id="modalSuksesLabel">Transaksi Selesai!</h5>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle text-success" style="font-size: 50px;"></i>
                    <h5 class="mt-3">Pembayaran Telah Dikonfirmasi</h5>
                    <p class="small text-muted">Detail pesanan kamu sudah kami terima dan akan segera diproses.</p>
                    <p class="fw-bold mb-0">Rincian:</p>
                    <p id="rincianProduk" class="mb-1 small"></p>
                    <p id="rincianHarga" class="fw-bold text-success"></p>
                </div>
                <div class="modal-footer d-block">
                    <button onclick="kirimWA()" class="btn btn-qris w-100 py-2 mb-2">
                        <i class="fab fa-whatsapp me-1"></i> KIRIM BUKTI KE ADMIN
                    </button>
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal" onclick="resetApp()">Oke, Kembali ke Toko</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // === KONFIGURASI FIREBASE KAMU ===
        const firebaseConfig = {
          apiKey: "AIzaSyB-cU3n9GQiO5dyaXgLF3mwGFPZ6ACqQds",
          authDomain: "appsphere-de73d.firebaseapp.com",
          projectId: "appsphere-de73d",
          storageBucket: "appsphere-de73d.firebasestorage.app",
          messagingSenderId: "610562583858",
          appId: "1:610562583858:web:7e252865c692af00783b2b",
          measurementId: "G-84ZR60FM03"
        };
        
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('produk');

        // === NOMOR WHATSAPP ADMIN (GANTI JIKA PERLU) ===
        const NOMOR_WA = "6289512345678"; 

        // Variabel Global
        let db = []; 
        let produkAktif = null, varianPilihan = null, timerInterval;
        let modalVarianInstance, modalBayarInstance, modalSuksesInstance;
        let trxData = {};
        let dbTransaksi = JSON.parse(localStorage.getItem('toko_trx')) || []; 

        // === FUNGSI UTAMA BARU: Ambil data dari Firebase secara Realtime ===
        dbRef.on('value', (snapshot) => {
            const dataObj = snapshot.val();
            db = [];
            if (dataObj) {
                Object.keys(dataObj).forEach(key => {
                    db.push({ id: key, ...dataObj[key] });
                });
                document.getElementById('msgKosong').style.display = 'none';
            } else {
                document.getElementById('msgKosong').style.display = 'block';
            }
            render('Semua');
        });

        window.onload = function() {
            modalVarianInstance = new bootstrap.Modal(document.getElementById('modalVarian'));
            modalBayarInstance = new bootstrap.Modal(document.getElementById('modalBayar'));
            modalSuksesInstance = new bootstrap.Modal(document.getElementById('modalSukses'));
            
            // Cek transaksi pending
            if(dbTransaksi.length > 0) {
                dbTransaksi.forEach(trx => {
                    if(trx.status === 'PENDING' && new Date().getTime() < trx.expired) {
                        trxData = trx;
                        lanjutBayar(true);
                    }
                });
            }
        }

        function cariProduk(keyword) {
            render('Semua', keyword.toUpperCase());
        }

        function render(kategori, keyword = '') {
            let grid = document.getElementById('productGrid');
            grid.innerHTML = "";
            let uniqueCategories = new Set();
            let produkDitemukan = false;

            db.forEach(p => {
                uniqueCategories.add(p.kat);
                let kategoriMatch = (kategori === 'Semua' || p.kat === kategori);
                let keywordMatch = (keyword === '' || p.nama.toUpperCase().includes(keyword));

                if (kategoriMatch && keywordMatch) {
                    produkDitemukan = true;
                    grid.innerHTML += `
                        <div class="col">
                            <div class="product-card" onclick="cekProduk('${p.nama}')">
                                <img src="${p.img}" class="card-img-top product-img" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                <div class="p-3">
                                    <h6 class="product-title text-truncate">${p.nama}</h6>
                                    <div class="product-category">${p.kat}</div>
                                    <div class="product-price">Rp ${parseInt(p.harga).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>`;
                }
            });

            if (!produkDitemukan && db.length > 0) {
                grid.innerHTML = `<div class="col-12"><div class="empty-message"><h5>Tidak Ada Produk Ditemukan</h5></div></div>`;
            } else if (db.length === 0) {
                document.getElementById('msgKosong').style.display = 'block';
            }

            if (keyword === '') { renderKategori(uniqueCategories, kategori); }
        }

        function renderKategori(categories, activeCategory) {
            let nav = document.getElementById('categoryNav');
            let html = `<div class="category-item ${activeCategory === 'Semua' ? 'active' : ''}" onclick="filterProduk('Semua', this)">Semua</div>`;
            categories.forEach(cat => {
                html += `<div class="category-item ${activeCategory === cat ? 'active' : ''}" onclick="filterProduk('${cat}', this)">${cat}</div>`;
            });
            nav.innerHTML = html;
        }

        function filterProduk(kategori, element) {
            document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('searchInput').value = '';
            render(kategori);
        }

        function cekProduk(namaProduk) {
            produkAktif = db.find(p => p.nama === namaProduk);
            if (!produkAktif) return;
            document.getElementById('modalVarianLabel').innerText = produkAktif.nama;
            let listHTML = "";

            if (produkAktif.varian && produkAktif.varian.length > 0) {
                produkAktif.varian.forEach((v, idx) => {
                    listHTML += `<div class="variant-option" onclick="pilihVarian(${idx}, this)"><div class="fw-bold">${v.nama}</div><span class="small text-muted">Rp ${parseInt(v.harga).toLocaleString()}</span></div>`;
                });
                document.getElementById('vTotalHarga').innerText = "Rp 0";
                document.getElementById('btnLanjutBayar').classList.add('disabled');
            }
            document.getElementById('listVarian').innerHTML = listHTML;
            modalVarianInstance.show();
        }

        function pilihVarian(idx, element) {
            document.querySelectorAll('.variant-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.desc-box-dynamic').forEach(el => el.remove());
            element.classList.add('selected');
            varianPilihan = produkAktif.varian[idx];
            if(varianPilihan.desk && varianPilihan.desk !== "-") { 
                element.insertAdjacentHTML('afterend', `<div class="desc-box-dynamic">${varianPilihan.desk}</div>`); 
            }
            document.getElementById('vTotalHarga').innerText = "Rp " + parseInt(varianPilihan.harga).toLocaleString();
            document.getElementById('btnLanjutBayar').classList.remove('disabled');
        }

        function bukaQRIS() {
            modalVarianInstance.hide();
            trxData = {
                id: 'TRX' + new Date().getTime(),
                produk: produkAktif.nama,
                varian: varianPilihan.nama,
                harga: parseInt(varianPilihan.harga),
                status: 'PENDING',
                created: new Date().getTime(),
                expired: new Date().getTime() + (15 * 60 * 1000)
            };
            dbTransaksi = dbTransaksi.filter(t => t.status !== 'PENDING' || t.expired < new Date().getTime());
            dbTransaksi.push(trxData);
            localStorage.setItem('toko_trx', JSON.stringify(dbTransaksi));
            lanjutBayar(false);
        }
        
        function lanjutBayar(isResumed) {
            document.getElementById('qTotal').innerText = "Total: Rp " + trxData.harga.toLocaleString();
            document.getElementById('inputNama').value = isResumed ? (trxData.nama || "") : "";
            document.getElementById('inputWA').value = isResumed ? (trxData.wa || "") : "";
            document.getElementById('inputCatatan').value = isResumed ? (trxData.catatan || "") : "";
            

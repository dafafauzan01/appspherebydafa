<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppSphere - Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* === TEMA WARNA (CSS VARIABLES) === */
        :root {
            /* Warna Default (DARK MODE) */
            --bg-body: #0f1219;
            --bg-header: #181b24;
            --bg-card: #1e222e;
            --bg-input: #232733;
            --text-main: #ffffff;
            --text-sec: #8b9bb4;
            --border-color: #2a2f3d;
            --accent-color: #4facfe;
            --shadow-color: rgba(0,0,0,0.3);
        }

        [data-theme="light"] {
            /* Warna LIGHT MODE */
            --bg-body: #f4f6f8;
            --bg-header: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f1f3f5;
            --text-main: #1a202c;
            --text-sec: #718096;
            --border-color: #e2e8f0;
            --accent-color: #3182ce; /* Biru lebih gelap dikit biar jelas */
            --shadow-color: rgba(0,0,0,0.05);
        }

        /* === GLOBAL STYLE === */
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh; 
            font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; 
            transition: background-color 0.3s, color 0.3s;
        }
        .main-container { max-width: 1100px; margin: 0 auto; background-color: var(--bg-body); min-height: 100vh; transition: 0.3s; }

        /* HEADER */
        .app-header { 
            background: var(--bg-header); padding: 15px 20px; 
            position: sticky; top: 0; z-index: 999; 
            border-bottom: 1px solid var(--border-color); 
            box-shadow: 0 4px 20px var(--shadow-color); 
            transition: 0.3s;
        }
        .logo-text { font-size: 24px; font-weight: 800; color: var(--text-main); text-decoration: none; display: flex; align-items: center; }
        .logo-text i { color: var(--accent-color); }
        
        .search-box { 
            background: var(--bg-input); border: 1px solid var(--border-color); 
            border-radius: 50px; color: var(--text-main); padding: 10px 20px; 
            width: 100%; outline: none; margin-top: 15px; font-size: 14px; 
        }
        .search-box:focus { border-color: var(--accent-color); background: var(--bg-header); }

        /* TOMBOL TEMA */
        .theme-toggle {
            cursor: pointer; font-size: 20px; color: var(--text-main);
            background: var(--bg-input); padding: 8px; border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .theme-toggle:hover { color: var(--accent-color); transform: rotate(15deg); }

        /* BANNER */
        .hero-container { padding: 20px; text-align: center; }
        .hero-banner { width: auto; max-width: 100%; height: auto; max-height: 380px; object-fit: contain; border-radius: 16px; box-shadow: 0 5px 15px var(--shadow-color); }

        /* CARD DESIGN */
        .section-title { font-size: 18px; font-weight: 700; color: var(--text-main); margin: 25px 0 15px 10px; border-left: 4px solid var(--accent-color); padding-left: 10px; }
        .game-card { 
            background: var(--bg-card); border-radius: 12px; overflow: hidden; 
            transition: transform 0.2s; cursor: pointer; 
            border: 1px solid var(--border-color); height: 100%; position: relative; 
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        .game-card:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        
        .card-img-wrapper { width: 100%; aspect-ratio: 1/1; overflow: hidden; border-bottom: 1px solid var(--border-color); position: relative; }
        .card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .game-card:hover .card-img-wrapper img { transform: scale(1.1); }
        
        .card-body { padding: 10px 5px; text-align: center; }
        .card-title { font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-category { font-size: 9px; color: var(--text-sec); display: block; margin-bottom: 4px; }
        .btn-card { background: var(--bg-input); color: var(--accent-color); font-size: 9px; padding: 2px 8px; border-radius: 20px; border: 1px solid var(--accent-color); display: inline-block; font-weight: bold; }
        
        /* BADGES */
        .badge-top-left { position: absolute; top: 0; left: 0; background: #ff9f43; color: #000; font-size: 8px; padding: 2px 6px; border-bottom-right-radius: 8px; font-weight: bold; z-index: 2; }
        .badge-top-right { position: absolute; top: 0; right: 0; background: #00f2fe; color: #000; font-size: 8px; padding: 2px 6px; border-bottom-left-radius: 8px; font-weight: bold; z-index: 2; }

        /* FILTER & NAV */
        .filter-scroll { overflow-x: auto; white-space: nowrap; padding: 0 20px 10px 20px; scrollbar-width: none; } 
        .btn-filter { display: inline-block; padding: 6px 14px; margin-right: 6px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-sec); font-size: 12px; cursor: pointer; }
        .btn-filter.active { background: var(--accent-color); color: #fff; font-weight: bold; border-color: var(--accent-color); }
        
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            height: 70px; background: var(--bg-header); border-top: 1px solid var(--border-color); 
            display: flex; justify-content: space-around; align-items: center; z-index: 1000; 
        }
        .nav-item { text-align: center; color: var(--text-sec); font-size: 11px; cursor: pointer; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 25%; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; display: block; }
        .nav-item.active { color: var(--accent-color); }
        
        /* MODALS & FORM */
        .modal-content { background: var(--bg-header); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 16px; }
        .variant-item { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; }
        .variant-item.selected { border-color: var(--accent-color); background: rgba(79,172,254,0.1); }
        .variant-item:hover { border-color: var(--accent-color); }
        
        /* Input Form yang menyesuaikan tema */
        .form-control-dark { 
            background-color: var(--bg-input) !important; 
            border: 1px solid var(--accent-color) !important; 
            color: var(--text-main) !important; 
            font-weight: 500; 
        }
        .form-control-dark::placeholder { color: var(--text-sec) !important; opacity: 0.8; }
        
        .btn-primary-custom { background: linear-gradient(90deg, #4facfe, #00f2fe); border: none; color: #000; font-weight: bold; width: 100%; padding: 10px; border-radius: 8px; }
        .data-instant-box { background: var(--bg-input); border: 1px dashed var(--accent-color); color: var(--accent-color); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; word-break: break-all; margin-bottom: 10px; }
        .text-muted { color: var(--text-sec) !important; }
        
        /* RESPONSIVE GRID */
        @media (min-width: 992px) { .col-lg-2 { width: 16.666%; } }
        @media (max-width: 768px) { .col-4 { width: 33.333%; padding: 4px; } .card-body { padding: 8px 4px; } .card-title { font-size: 10px; } .btn-card { font-size: 8px; padding: 2px 6px; } }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="app-header">
            <div class="d-flex justify-content-between align-items-center">
                <a href="index.html" class="logo-text"><i class="fas fa-cube me-2"></i>AppSphere</a>
                <div class="d-flex align-items-center">
                    <div class="theme-toggle me-3" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </div>
                    <a href="login.html" class="text-secondary"><i class="fas fa-user-circle fa-2x" style="color: var(--text-sec);"></i></a>
                </div>
            </div>
            <input type="text" id="searchInput" class="search-box" placeholder="Cari game atau aplikasi..." onkeyup="cariProduk()">
        </div>

        <div class="hero-container"><img src="banner.png" class="hero-banner" alt="Banner Promo" onerror="this.style.display='none'"></div>

        <div class="filter-scroll">
            <div class="btn-filter active" onclick="filterProduk('Semua', this)">Semua</div>
            <div class="btn-filter" onclick="filterProduk('Streaming', this)">Streaming</div>
            <div class="btn-filter" onclick="filterProduk('Editing', this)">Editing</div>
            <div class="btn-filter" onclick="filterProduk('AI Tools', this)">AI Tools</div>
            <div class="btn-filter" onclick="filterProduk('Utility', this)">Utility</div>
            <div class="btn-filter" onclick="filterProduk('Sosmed', this)">Sosmed</div>
            <div class="btn-filter" onclick="filterProduk('VPN', this)">VPN</div>
        </div>

        <div id="areaProduk" class="row g-2 px-3 pb-5"></div>
        <div id="msgKosong" class="text-center mt-5 text-secondary" style="display:none;"><i class="fas fa-ghost fa-3x mb-3"></i><p>Produk tidak ditemukan.</p></div>
    </div> 

    <div class="bottom-nav">
        <div class="nav-item" onclick="new bootstrap.Modal(document.getElementById('modalCariOrder')).show()">
            <i class="fas fa-search"></i><span>Cek Order</span>
        </div>
        <div class="nav-item" onclick="new bootstrap.Modal(document.getElementById('modalCaraOrder')).show()">
            <i class="fas fa-book-open"></i><span>Cara Order</span>
        </div>
        <div class="nav-item active" onclick="location.reload()">
            <i class="fas fa-home"></i><span>Beranda</span>
        </div>
        <a href="testimoni.html" class="nav-item">
            <i class="fas fa-star"></i><span>Testimoni</span>
        </a>
    </div>

    <div class="modal fade" id="modalVarian" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="fw-bold mb-0" id="vNamaProduk">Produk</h5><button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button></div><div class="modal-body"><div id="listVarian"></div></div><div class="modal-footer d-block border-0 pt-0"><div class="d-flex justify-content-between mb-2"><small>Total:</small><span id="vTotalHarga" class="fw-bold text-primary">Rp 0</span></div><button id="btnLanjutBayar" class="btn btn-primary-custom disabled" onclick="bukaQRIS()">LANJUT BAYAR</button></div></div></div></div>
    <div class="modal fade" id="modalCariOrder" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h6 class="fw-bold mb-0">Cek Status Pesanan</h6><button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button></div><div class="modal-body pt-0">
        <p class="small text-muted mb-2">Masukkan Order ID (Contoh: TRX-17823) untuk melihat barang/status pesanan.</p>
        <div class="input-group mb-3">
            <input type="text" id="inputCariTRX" class="form-control form-control-dark" placeholder="Masukkan Order ID...">
            <button class="btn btn-primary" onclick="lacakPesanan()"><i class="fas fa-search"></i></button>
        </div>
        <div id="hasilPencarian" class="order-result">
            <div class="text-center mb-3 border-bottom border-secondary pb-2"><i class="fas fa-receipt fa-2x text-primary mb-2"></i><h6 class="fw-bold">Detail Pesanan</h6></div>
            <div>
                <div class="label-result">ID Order:</div><div class="value-result text-info" id="resID">-</div>
                <div class="label-result">Produk:</div><div class="value-result" id="resProduk">-</div>
                <div class="label-result">Status:</div><div class="value-result"><span class="badge bg-success">LUNAS</span></div>
                <div id="boxBarang" style="display:none;"><div class="label-result text-warning mt-3">DATA BARANG / AKUN:</div><div class="data-instant-box mt-1" id="resDataBarang"></div><button onclick="copyDataRes()" class="btn btn-sm btn-outline-info w-100"><i class="fas fa-copy me-1"></i> Salin Data</button></div>
            </div>
        </div>
    </div></div></div></div>

    <div class="modal fade" id="modalBayar" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h6 class="fw-bold mb-0">Pembayaran QRIS</h6><button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button></div><div class="modal-body text-center pt-0">
        <div class="alert alert-primary py-1 px-2 d-inline-block small mb-3"><i class="fas fa-clock"></i> <span id="countdown">10:00</span></div>
        <div class="bg-white p-2 rounded mb-3 mx-auto" style="width: 180px;"><img src="qris.jpg" class="img-fluid" onerror="this.src='https://via.placeholder.com/200?text=QRIS'"></div>
        <h4 class="fw-bold text-primary mb-3" id="qTotal">Rp 0</h4>
        <div class="text-start p-3 rounded border border-secondary" style="background: var(--bg-input);">
            <div id="infoInstant" class="badge bg-info text-dark mb-2 w-100" style="display:none;"><i class="fas fa-bolt"></i> Produk Instant Delivery</div>
            <label class="small text-muted ms-1 mb-1">Nama Pembeli:</label><input type="text" id="inputNama" class="form-control form-control-dark mb-2 form-control-sm" placeholder="Masukkan Nama Kamu...">
            <label class="small text-muted ms-1 mb-1">Nomor WhatsApp:</label><input type="number" id="inputWA" class="form-control form-control-dark mb-2 form-control-sm" placeholder="Contoh: 08123456789">
            <textarea id="inputCatatan" class="form-control form-control-dark form-control-sm" rows="2" style="display:none;" placeholder="Catatan (Email/Akun)"></textarea>
        </div>
        <button onclick="tandaiLunas()" class="btn btn-primary-custom mt-3">SAYA SUDAH BAYAR</button>
    </div></div></div></div>

    <div class="modal fade" id="modalSukses" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><i class="fas fa-check-circle text-success mb-3" style="font-size: 50px;"></i><h5 class="fw-bold">Pesanan Dibuat!</h5><p class="small text-muted mb-3">Segera kirim bukti pembayaran.</p><div class="p-2 rounded border border-secondary mb-3 text-start small" style="background: var(--bg-input);">Order ID: <span id="sId" class="text-info fw-bold"></span><br><span class="text-muted" style="font-size:10px;">*Simpan Order ID ini untuk cek pesanan.</span></div><div class="mb-3 text-center p-3 rounded border border-info" style="background: var(--bg-input);" onclick="triggerUpload()"><i id="iconUploadBukti" class="fas fa-cloud-upload-alt fa-lg text-info me-2"></i><span id="textUploadBukti" class="small text-info fw-bold">KLIK UNTUK UPLOAD BUKTI</span><div id="progressArea" class="progress mt-2" style="height: 5px; display: none;"><div id="progressBar" class="progress-bar bg-info" style="width: 0%"></div></div><img id="previewBukti" src="" style="max-height: 100px; display: none;" class="mx-auto d-block mt-2 rounded"></div><input type="file" id="fileBukti" class="d-none" accept="image/*"><input type="hidden" id="linkBuktiHosting"><button id="btnKirimWA" onclick="kirimWAOtomatis()" class="btn btn-success w-100 fw-bold mb-2 disabled"><i class="fab fa-whatsapp me-2"></i>KIRIM KONFIRMASI (Tunggu Upload)</button><button onclick="location.reload()" class="btn btn-outline-secondary w-100 btn-sm">Tutup</button></div></div></div>
    <div class="modal fade" id="modalInstant" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><i class="fas fa-bolt text-warning mb-3" style="font-size: 50px;"></i><h5 class="fw-bold">Pembayaran Dikonfirmasi!</h5><div class="p-2 rounded border border-secondary mb-3 text-start small" style="background: var(--bg-input);">Order ID: <span id="iId" class="text-info fw-bold"></span><br><span class="text-muted" style="font-size:10px;">*Gunakan ID ini untuk cek kembali data nanti.</span></div><div class="data-instant-box"><span id="textDataInstant">Memuat data...</span><button onclick="copyData()" class="btn btn-sm btn-outline-info position-absolute top-0 end-0 m-1" style="font-size:10px;">Salin</button></div><div class="alert alert-warning small py-1" style="font-size: 11px;">Simpan data ini. Halaman akan hilang jika ditutup.</div><button onclick="laporAdminInstant()" class="btn btn-success w-100 fw-bold mb-2"><i class="fab fa-whatsapp me-2"></i>Lapor Admin (Selesai)</button><button onclick="location.reload()" class="btn btn-outline-secondary w-100 btn-sm">Tutup</button></div></div></div>
    <div class="modal fade" id="modalCaraOrder" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0"><h6 class="fw-bold mb-0">Cara Order</h6><button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button></div><div class="modal-body small pt-0"><ol class="ps-3 mb-0"><li>Pilih produk.</li><li>Isi data & Bayar QRIS.</li><li>Simpan <b>Order ID</b>.</li><li>Cek Status di menu 'Cek Order'.</li></ol></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <script>
        const IMGBB_API_KEY = "d7ec6530cf6e558c2af55e645a091e6e"; 
        const NOMOR_WA = "6283843400022";

        const firebaseConfig = {
          apiKey: "AIzaSyB-cU3n9GQiO5dyaXgLF3mwGFPZ6ACqQds",
          authDomain: "appsphere-de73d.firebaseapp.com",
          databaseURL: "https://appsphere-de73d-default-rtdb.firebaseio.com",
          projectId: "appsphere-de73d",
          storageBucket: "appsphere-de73d.firebasestorage.app",
          messagingSenderId: "610562583858",
          appId: "1:610562583858:web:7e252865c692af00783b2b",
          measurementId: "G-84ZR60FM03"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('produk');
        let db = [];
        let produkAktif, varianPilihan, timerInterval, trxData = {};
        let modalVarianInstance, modalBayarInstance, modalSuksesInstance, modalInstantInstance;

        window.onload = () => {
            modalVarianInstance = new bootstrap.Modal(document.getElementById('modalVarian'));
            modalBayarInstance = new bootstrap.Modal(document.getElementById('modalBayar'));
            modalSuksesInstance = new bootstrap.Modal(document.getElementById('modalSukses'));
            modalInstantInstance = new bootstrap.Modal(document.getElementById('modalInstant'));
            document.getElementById('fileBukti').addEventListener('change', uploadKeImgBB);
            document.getElementById('modalSukses').addEventListener('hide.bs.modal', resetUploadStatus);
            
            // LOAD THEME DARI MEMORI
            let savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            dbRef.on('value', (s) => {
                const d = s.val(); db = [];
                if(d) Object.keys(d).forEach(k => db.push({id:k, ...d[k]}));
                render('Semua');
            });
        };

        // --- FITUR DARK/LIGHT MODE ---
        function toggleTheme() {
            let body = document.body;
            let current = body.getAttribute('data-theme');
            let next = current === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
        }
        function updateThemeIcon(theme) {
            let icon = document.getElementById('themeIcon');
            if(theme === 'light') { icon.className = 'fas fa-sun text-warning'; } 
            else { icon.className = 'fas fa-moon text-white'; }
        }

        // --- FUNGSI RENDER GRID ---
        function render(c) {
            let data = (c === 'Semua') ? db : db.filter(p => p.kat === c);
            let h = document.getElementById('areaProduk'); h.innerHTML = '';
            if(data.length === 0) { document.getElementById('msgKosong').style.display = 'block'; return; }
            document.getElementById('msgKosong').style.display = 'none';
            const groupedData = data.reduce((acc, p) => { const category = p.kat || 'Lainnya'; if (!acc[category]) acc[category] = []; acc[category].push(p); return acc; }, {});
            Object.keys(groupedData).sort().forEach(kat => {
                let icon = 'fa-cube';
                if(kat === 'Streaming') icon = 'fa-play-circle'; else if(kat === 'Editing') icon = 'fa-pen-nib'; else if(kat === 'AI Tools') icon = 'fa-robot'; else if(kat === 'Utility') icon = 'fa-tools'; else if(kat === 'Sosmed') icon = 'fa-hashtag'; else if(kat === 'VPN') icon = 'fa-shield-alt'; else if(kat === 'Game') icon = 'fa-gamepad';
                h.innerHTML += `<div class="col-12"><div class="section-title"><i class="fas ${icon} me-2 text-primary"></i> ${kat.toUpperCase()}</div></div>`;
                groupedData[kat].forEach((p) => {
                    let pr = (p.varian && p.varian.length > 0) ? p.varian[0].harga : (p.harga || 0);
                    let isHotBadge = p.isHot ? '<div class="badge-top-left">HOT ðŸ”¥</div>' : '';
                    let instantBadge = (p.tipeKirim === 'instant') ? '<div class="badge-top-right">AUTO âš¡</div>' : '';
                    h.innerHTML += `<div class="col-4 col-md-2"><div class="game-card" onclick="cekProduk('${p.id}')">${isHotBadge} ${instantBadge}<div class="card-img-wrapper"><img src="${p.img}" onerror="this.src='https://via.placeholder.com/150'"></div><div class="card-body"><div class="card-title">${p.nama}</div><span class="card-category">${p.kat}</span><div class="btn-card">Rp ${parseInt(pr).toLocaleString()}</div></div></div></div>`;
                });
            });
        }

        // --- FUNGSI LACAK PESANAN ---
        function lacakPesanan() {
            let id = document.getElementById('inputCariTRX').value.trim();
            if(!id) return alert("Masukkan Order ID dulu!");
            firebase.database().ref('transaksi/' + id).once('value').then((snapshot) => {
                if(snapshot.exists()) {
                    let data = snapshot.val();
                    document.getElementById('resID').innerText = data.id;
                    document.getElementById('resProduk').innerText = data.produk + " - " + data.varian;
                    let boxBarang = document.getElementById('boxBarang');
                    if(data.dataBarang && data.dataBarang !== "-") {
                        boxBarang.style.display = 'block'; document.getElementById('resDataBarang').innerText = data.dataBarang;
                    } else { boxBarang.style.display = 'none'; }
                    document.getElementById('hasilPencarian').style.display = 'block';
                } else { alert("Order ID tidak ditemukan!"); document.getElementById('hasilPencarian').style.display = 'none'; }
            });
        }
        function copyDataRes() { navigator.clipboard.writeText(document.getElementById('resDataBarang').innerText).then(() => alert("Data tersalin!")); }

        // --- FUNGSI LAIN ---
        function filterProduk(c, el) { document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active')); el.classList.add('active'); render(c); }
        function cariProduk() { let key = document.getElementById('searchInput').value.toLowerCase(); renderGrid(db.filter(p => p.nama.toLowerCase().includes(key))); }
        function cekProduk(id) {
            let p = db.find(item => item.id === id); produkAktif = p;
            document.getElementById('vNamaProduk').innerText = produkAktif.nama;
            let h = "";
            if(produkAktif.varian) produkAktif.varian.forEach((v, x) => {
                let stok = v.stok !== undefined ? v.stok : 99; let habis = stok <= 0;
                h += `<div class="variant-item ${habis ? 'disabled' : ''}" onclick="${habis ? '' : `pilihVarian(${x}, this)`}"><div><div class="variant-name">${v.nama}</div><div class="variant-stok ${habis ? 'text-danger' : 'text-success'}">${habis ? 'Habis' : 'Stok: '+stok}</div></div><div class="variant-price">Rp ${parseInt(v.harga).toLocaleString()}</div></div>`;
            });
            document.getElementById('listVarian').innerHTML = h; document.getElementById('vTotalHarga').innerText = "Rp 0";
            document.getElementById('btnLanjutBayar').classList.add('disabled'); modalVarianInstance.show();
        }
        function pilihVarian(x, el) {
            document.querySelectorAll('#listVarian .variant-item').forEach(e => e.classList.remove('selected')); el.classList.add('selected');
            varianPilihan = { ...produkAktif.varian[x], index: x };
            document.getElementById('vTotalHarga').innerText = "Rp " + parseInt(varianPilihan.harga).toLocaleString();
            document.getElementById('btnLanjutBayar').classList.remove('disabled');
        }
        function bukaQRIS() {
            modalVarianInstance.hide();
            document.getElementById('qTotal').innerText = "Rp " + parseInt(varianPilihan.harga).toLocaleString();
            document.getElementById('inputNama').value = ""; document.getElementById('inputWA').value = ""; document.getElementById('inputCatatan').value = "";
            let infoInstant = document.getElementById('infoInstant');
            infoInstant.style.display = (produkAktif.tipeKirim === 'instant') ? 'block' : 'none';
            document.getElementById('inputCatatan').style.display = (produkAktif.formType === 'lengkap') ? 'block' : 'none';
            let d = 600; clearInterval(timerInterval);
            timerInterval = setInterval(() => { let m = Math.floor(d/60), s = d%60; document.getElementById('countdown').innerText = `${m}:${s<10?'0':''}${s}`; if(--d < 0) { clearInterval(timerInterval); modalBayarInstance.hide(); alert('Waktu Habis'); } }, 1000);
            modalBayarInstance.show();
        }
        function tandaiLunas() {
            let n = document.getElementById('inputNama').value, w = document.getElementById('inputWA').value;
            if(!n || !w) return alert("Nama & WA Wajib!");
            firebase.database().ref(`produk/${produkAktif.id}/varian/${varianPilihan.index}/stok`).transaction((c) => (c || 0) - 1);
            clearInterval(timerInterval);
            let uniqueID = 'TRX-' + Math.floor(Date.now() / 1000); 
            let isiDataBarang = (produkAktif.tipeKirim === 'instant' && produkAktif.dataInstant) ? produkAktif.dataInstant : "-";
            let transaksiBaru = { id: uniqueID, nama: n, wa: w, produk: produkAktif.nama, varian: varianPilihan.nama, harga: "Rp "+parseInt(varianPilihan.harga).toLocaleString(), catatan: document.getElementById('inputCatatan').value || "-", dataBarang: isiDataBarang, tanggal: new Date().toLocaleString() };
            firebase.database().ref('transaksi/' + uniqueID).set(transaksiBaru);
            trxData = transaksiBaru;
            modalBayarInstance.hide(); 
            if(produkAktif.tipeKirim === 'instant' && produkAktif.dataInstant) {
                document.getElementById('textDataInstant').innerText = produkAktif.dataInstant; document.getElementById('iId').innerText = uniqueID; modalInstantInstance.show();
            } else { 
                document.getElementById('sId').innerText = uniqueID; modalSuksesInstance.show(); 
            }
        }
        function resetUploadStatus() {
            document.getElementById('fileBukti').value = ''; document.getElementById('linkBuktiHosting').value = ''; document.getElementById('previewBukti').style.display = 'none';
            document.getElementById('textUploadBukti').innerText = "KLIK UNTUK UPLOAD BUKTI"; document.getElementById('textUploadBukti').className = "small text-info fw-bold";
            document.getElementById('iconUploadBukti').className = "fas fa-cloud-upload-alt fa-lg text-info me-2"; document.getElementById('progressArea').style.display = 'none'; document.getElementById('progressBar').style.width = '0%';
            document.getElementById('btnKirimWA').classList.add('disabled'); document.getElementById('btnKirimWA').innerHTML = '<i class="fab fa-whatsapp me-2"></i>KIRIM KONFIRMASI (Tunggu Upload)';
        }
        function triggerUpload() { document.getElementById('fileBukti').click(); }
        function uploadKeImgBB(event) {
            const file = event.target.files[0]; if (!file) return;
            const textUpload = document.getElementById('textUploadBukti'); const preview = document.getElementById('previewBukti');
            const progressArea = document.getElementById('progressArea'); const progressBar = document.getElementById('progressBar');
            const reader = new FileReader(); reader.onload = function(e){ preview.src = e.target.result; preview.style.display = 'block'; }; reader.readAsDataURL(file);
            textUpload.innerText = "â³ Sedang Mengupload..."; progressArea.style.display = 'flex'; progressBar.style.width = '50%';
            const formData = new FormData(); formData.append("image", file);
            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData })
            .then(response => response.json()).then(result => {
                if (result.success) {
                    document.getElementById('linkBuktiHosting').value = result.data.url; progressBar.style.width = '100%';
                    setTimeout(() => {
                        textUpload.innerText = "âœ… UPLOAD SUKSES!"; textUpload.className = "small text-success fw-bold";
                        document.getElementById('iconUploadBukti').className = "fas fa-check-circle fa-lg text-success me-2";
                        document.getElementById('btnKirimWA').classList.remove('disabled');
                        document.getElementById('btnKirimWA').innerHTML = '<i class="fab fa-whatsapp me-2"></i>KIRIM KONFIRMASI SEKARANG';
                        progressBar.classList.remove('bg-info'); progressBar.classList.add('bg-success');
                    }, 500);
                } else { alert("Gagal Upload: " + result.error.message); }
            }).catch(error => { alert("Error koneksi ImgBB."); });
        }
        function kirimWAOtomatis() {
            let linkGambar = document.getElementById('linkBuktiHosting').value; if (!linkGambar) return alert("Harap tunggu sampai proses upload selesai!");
            let t = `Halo Admin, saya order via Web.%0A%0A*ID:* ${trxData.id}%0A*Nama:* ${trxData.nama}%0A*Item:* ${trxData.produk}%0A*Varian:* ${trxData.varian}%0A*Total:* ${trxData.harga}%0A*Catatan:* ${trxData.catatan}%0A%0A*Bukti Transfer:*%0A${linkGambar}`;
            window.open(`https://wa.me/${NOMOR_WA}?text=${t}`, '_blank');
        }
        function laporAdminInstant() {
            let t = `Halo Admin, saya sudah ambil produk *INSTANT DELIVERY* via Web.%0A%0A*ID:* ${trxData.id}%0A*Nama:* ${trxData.nama}%0A*Item:* ${trxData.produk}%0A*Varian:* ${trxData.varian}%0A*Total:* ${trxData.harga}%0A%0A*Status:* âœ… Sukses Ambil Data`;
            window.open(`https://wa.me/${NOMOR_WA}?text=${t}`, '_blank');
        }
        function copyData() { navigator.clipboard.writeText(document.getElementById('textDataInstant').innerText).then(() => alert("Data tersalin!")); }
    </script>
</body>
</html>

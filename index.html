<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppSphere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* BACKGROUND & FONT UTAMA (TEMA BIRU) */
        body { background-color: #0a0e17; color: #e0e6ed; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; background-image: radial-gradient(circle at top center, #1a2235 0%, #0a0e17 70%); }
        
        /* HEADER BIRU */
        .app-header { background: rgba(10, 14, 23, 0.9); backdrop-filter: blur(15px); padding: 15px 0; border-bottom: 1px solid #1c263d; position: sticky; top: 0; z-index: 1000; }
        .logo-text { font-size: 24px; font-weight: 800; background: linear-gradient(45deg, #4facfe, #a6c1ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* SEARCH BAR */
        .search-container { background-color: #131a2a; border-radius: 25px; padding: 5px 15px; border: 1px solid #1c263d; transition: border-color 0.3s; }
        .search-container:focus-within { border-color: #4facfe; }
        .search-input { background: transparent; border: none; color: #e0e6ed; outline: none; padding: 5px 0; }
        .search-input::placeholder { color: #8a99b3; }
        
        /* NAVIGASI KATEGORI */
        .category-nav { overflow-x: auto; white-space: nowrap; padding: 10px 0; -webkit-overflow-scrolling: touch; }
        .category-nav::-webkit-scrollbar { display: none; }
        .category-item { display: inline-block; padding: 8px 15px; margin-right: 8px; background: #1c263d; border-radius: 20px; color: #a6c1ee; font-size: 14px; cursor: pointer; border: 1px solid #1c263d; transition: all 0.2s; }
        .category-item:hover { background: #2a3a5a; }
        .category-item.active { background: linear-gradient(45deg, #4facfe, #a6c1ee); color: #0a0e17; font-weight: bold; border-color: #4facfe; box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3); }
        
        /* GRID PRODUK */
        .product-card { background: #131a2a; border: 1px solid #1c263d; border-radius: 15px; overflow: hidden; height: 100%; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(79, 172, 254, 0.15); }
        .product-img { height: 150px; object-fit: cover; border-bottom: 1px solid #1c263d; }
        .product-title { font-size: 16px; font-weight: 700; color: #e0e6ed; }
        .product-category { font-size: 12px; color: #a6c1ee; background: #1c263d; padding: 3px 8px; border-radius: 8px; display: inline-block; margin-top: 5px; }
        .product-price { font-size: 18px; font-weight: 800; color: #4facfe; margin-top: 5px; }
        
        /* FOOTER NAV */
        .app-footer { background: rgba(10, 14, 23, 0.95); backdrop-filter: blur(15px); border-top: 1px solid #1c263d; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 10px 0; }
        .nav-item-footer { color: #8a99b3; transition: color 0.2s; font-size: 12px; }
        .nav-item-footer i { font-size: 20px; margin-bottom: 3px; }
        .nav-item-footer:hover, .nav-item-footer.active { color: #4facfe; }

        /* MODAL */
        .modal-content { background: #131a2a; color: #e0e6ed; border-radius: 20px; border: 1px solid #1c263d; }
        .modal-header { border-bottom: 1px solid #1c263d; }
        .modal-footer { border-top: 1px solid #1c263d; }
        .variant-option { background: #1c263d; border: 1px solid #2a3a5a; border-radius: 10px; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .variant-option:hover { background: #2a3a5a; }
        .variant-option.selected { background: #4facfe; border-color: #4facfe; color: #0a0e17; font-weight: bold; box-shadow: 0 0 10px rgba(79, 172, 254, 0.5); }
        .desc-box-dynamic { background: #2a3a5a; border-left: 3px solid #4facfe; padding: 10px; margin-top: 5px; border-radius: 5px; font-size: 14px; color: #a6c1ee; }
        .btn-qris { background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; color: white; font-weight: bold; }
        .btn-qris:hover { background: linear-gradient(45deg, #00f2fe, #4facfe); }
        .qris-box { background: #0a0e17; padding: 15px; border-radius: 10px; border: 1px solid #1c263d; }
        .qris-timer { font-size: 18px; font-weight: bold; color: #4facfe; }
        .form-control, .form-select { background: #1c263d; border: 1px solid #2a3a5a; color: #ffffff; }
        .form-control:focus, .form-select:focus { background: #1c263d; border-color: #4facfe; color: #ffffff; box-shadow: 0 0 5px rgba(79, 172, 254, 0.3); }

        /* KOSONG */
        .empty-message { text-align: center; padding: 50px 0; color: #8a99b3; }
        .empty-message i { font-size: 40px; margin-bottom: 15px; color: #1c263d; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="logo-text">AppSphere</div>
        </div>
        <div class="container mt-3">
            <div class="search-container d-flex align-items-center">
                <i class="fas fa-search me-2 text-muted"></i>
                <input type="text" id="searchInput" onkeyup="cariProduk(this.value)" class="search-input flex-grow-1" placeholder="Cari Produk atau Jasa...">
            </div>
        </div>
    </header>

    <div class="container mt-3">
        <div class="category-nav" id="categoryNav">
            <div class="category-item active" onclick="filterProduk('Semua', this)">Semua</div>
        </div>
    </div>
    
    <main class="container my-4">
        <div id="msgKosong" class="empty-message" style="display: none;">
            <i class="fas fa-box-open"></i>
            <h5>Produk Kosong</h5>
            <p>Admin belum menambahkan produk apapun.</p>
        </div>
        <div class="row row-cols-2 row-cols-md-4 g-3" id="productGrid"></div>
    </main>

    <footer class="app-footer">
        <div class="container">
            <div class="row text-center">
                <div class="col"><a href="index.html" class="d-flex flex-column align-items-center nav-item-footer active"><i class="fas fa-store"></i><span>Toko</span></a></div>
                <div class="col"><a href="testimoni.html" class="d-flex flex-column align-items-center nav-item-footer"><i class="fas fa-images"></i><span>Bukti</span></a></div>
                <div class="col"><a href="login.html" class="d-flex flex-column align-items-center nav-item-footer"><i class="fas fa-user-shield"></i><span>Admin</span></a></div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="modalVarian" tabindex="-1" aria-labelledby="modalVarianLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVarianLabel">Pilih Varian Produk</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-2">Pilih salah satu varian di bawah:</p>
                    <div id="listVarian"></div>
                </div>
                <div class="modal-footer d-block">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Total Harga:</span>
                        <span class="fw-bold fs-5" id="vTotalHarga">Rp 0</span>
                    </div>
                    <button type="button" class="btn btn-qris w-100 disabled" id="btnLanjutBayar" onclick="bukaQRIS()">Lanjut Pembayaran <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBayar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalBayarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalBayarLabel">Selesaikan Transaksi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="batalkanTransaksi()"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="qris-box mb-3">
                        <img src="qris.jpg" class="img-fluid rounded mb-2" onerror="this.src='https://via.placeholder.com/200?text=QRIS+NOT+FOUND'">
                        <p class="mb-0 small text-muted">Scan QRIS di atas untuk pembayaran</p>
                    </div>
                    
                    <p class="mb-1">Waktu Pembayaran Tersisa:</p>
                    <h4 class="qris-timer mb-3" id="timer">00:00</h4>

                    <p class="fw-bold mb-1" id="qTotal">Total: Rp 0</p>
                    <p class="small text-warning" id="qDeadline"></p>

                    <hr>

                    <form id="formKonfirmasi">
                        <p class="small text-muted">Masukkan detail kamu untuk konfirmasi:</p>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="inputNama" placeholder="Nama Kamu" required>
                        </div>
                        <div class="mb-3">
                            <input type="number" class="form-control" id="inputWA" placeholder="Nomor WhatsApp (Contoh: 628xxxxxx)" required>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="inputCatatan" rows="2" placeholder="Catatan Tambahan (Opsional)"></textarea>
                        </div>
                        <button type="submit" class="btn btn-qris w-100">KONFIRMASI PEMBAYARAN <i class="fas fa-check-circle ms-2"></i></button>
                    </form>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSukses" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalSuksesLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success" id="modalSuksesLabel">Transaksi Selesai!</h5>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle text-success" style="font-size: 50px;"></i>
                    <h5 class="mt-3">Pembayaran Telah Dikonfirmasi</h5>
                    <p class="small text-muted">Detail pesanan kamu sudah kami terima dan akan segera diproses.</p>
                    <p class="fw-bold mb-0">Rincian:</p>
                    <p id="rincianProduk" class="mb-1 small"></p>
                    <p id="rincianHarga" class="fw-bold text-success"></p>
                </div>
                <div class="modal-footer d-block">
                    <button onclick="kirimWA()" class="btn btn-qris w-100 py-2 mb-2">
                        <i class="fab fa-whatsapp me-1"></i> KIRIM BUKTI KE ADMIN
                    </button>
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal" onclick="resetApp()">Oke, Kembali ke Toko</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // === KONFIGURASI FIREBASE KAMU ===
        const firebaseConfig = {
          apiKey: "AIzaSyB-cU3n9GQiO5dyaXgLF3mwGFPZ6ACqQds",
          authDomain: "appsphere-de73d.firebaseapp.com",
          projectId: "appsphere-de73d",
          storageBucket: "appsphere-de73d.firebasestorage.app",
          messagingSenderId: "610562583858",
          appId: "1:610562583858:web:7e252865c692af00783b2b",
          measurementId: "G-84ZR60FM03"
        };
        
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('produk');

        // === NOMOR WHATSAPP ADMIN (GANTI JIKA PERLU) ===
        const NOMOR_WA = "6289512345678"; 

        // Variabel Global
        let db = []; 
        let produkAktif = null, varianPilihan = null, timerInterval;
        let modalVarianInstance, modalBayarInstance, modalSuksesInstance;
        let trxData = {};
        let dbTransaksi = JSON.parse(localStorage.getItem('toko_trx')) || []; 

        // === FUNGSI UTAMA BARU: Ambil data dari Firebase secara Realtime ===
        dbRef.on('value', (snapshot) => {
            const dataObj = snapshot.val();
            db = [];
            if (dataObj) {
                Object.keys(dataObj).forEach(key => {
                    db.push({ id: key, ...dataObj[key] });
                });
                document.getElementById('msgKosong').style.display = 'none';
            } else {
                document.getElementById('msgKosong').style.display = 'block';
            }
            render('Semua');
        });

        window.onload = function() {
            modalVarianInstance = new bootstrap.Modal(document.getElementById('modalVarian'));
            modalBayarInstance = new bootstrap.Modal(document.getElementById('modalBayar'));
            modalSuksesInstance = new bootstrap.Modal(document.getElementById('modalSukses'));
            
            // Cek transaksi pending
            if(dbTransaksi.length > 0) {
                dbTransaksi.forEach(trx => {
                    if(trx.status === 'PENDING' && new Date().getTime() < trx.expired) {
                        trxData = trx;
                        lanjutBayar(true);
                    }
                });
            }
        }

        function cariProduk(keyword) {
            render('Semua', keyword.toUpperCase());
        }

        function render(kategori, keyword = '') {
            let grid = document.getElementById('productGrid');
            grid.innerHTML = "";
            let uniqueCategories = new Set();
            let produkDitemukan = false;

            db.forEach(p => {
                uniqueCategories.add(p.kat);
                let kategoriMatch = (kategori === 'Semua' || p.kat === kategori);
                let keywordMatch = (keyword === '' || p.nama.toUpperCase().includes(keyword));

                if (kategoriMatch && keywordMatch) {
                    produkDitemukan = true;
                    grid.innerHTML += `
                        <div class="col">
                            <div class="product-card" onclick="cekProduk('${p.nama}')">
                                <img src="${p.img}" class="card-img-top product-img" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                <div class="p-3">
                                    <h6 class="product-title text-truncate">${p.nama}</h6>
                                    <div class="product-category">${p.kat}</div>
                                    <div class="product-price">Rp ${parseInt(p.harga).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>`;
                }
            });

            if (!produkDitemukan && db.length > 0) {
                grid.innerHTML = `<div class="col-12"><div class="empty-message"><h5>Tidak Ada Produk Ditemukan</h5></div></div>`;
            } else if (db.length === 0) {
                document.getElementById('msgKosong').style.display = 'block';
            }

            if (keyword === '') { renderKategori(uniqueCategories, kategori); }
        }

        function renderKategori(categories, activeCategory) {
            let nav = document.getElementById('categoryNav');
            let html = `<div class="category-item ${activeCategory === 'Semua' ? 'active' : ''}" onclick="filterProduk('Semua', this)">Semua</div>`;
            categories.forEach(cat => {
                html += `<div class="category-item ${activeCategory === cat ? 'active' : ''}" onclick="filterProduk('${cat}', this)">${cat}</div>`;
            });
            nav.innerHTML = html;
        }

        function filterProduk(kategori, element) {
            document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('searchInput').value = '';
            render(kategori);
        }

        function cekProduk(namaProduk) {
            produkAktif = db.find(p => p.nama === namaProduk);
            if (!produkAktif) return;
            document.getElementById('modalVarianLabel').innerText = produkAktif.nama;
            let listHTML = "";

            if (produkAktif.varian && produkAktif.varian.length > 0) {
                produkAktif.varian.forEach((v, idx) => {
                    listHTML += `<div class="variant-option" onclick="pilihVarian(${idx}, this)"><div class="fw-bold">${v.nama}</div><span class="small text-muted">Rp ${parseInt(v.harga).toLocaleString()}</span></div>`;
                });
                document.getElementById('vTotalHarga').innerText = "Rp 0";
                document.getElementById('btnLanjutBayar').classList.add('disabled');
            }
            document.getElementById('listVarian').innerHTML = listHTML;
            modalVarianInstance.show();
        }

        function pilihVarian(idx, element) {
            document.querySelectorAll('.variant-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.desc-box-dynamic').forEach(el => el.remove());
            element.classList.add('selected');
            varianPilihan = produkAktif.varian[idx];
            if(varianPilihan.desk && varianPilihan.desk !== "-") { 
                element.insertAdjacentHTML('afterend', `<div class="desc-box-dynamic">${varianPilihan.desk}</div>`); 
            }
            document.getElementById('vTotalHarga').innerText = "Rp " + parseInt(varianPilihan.harga).toLocaleString();
            document.getElementById('btnLanjutBayar').classList.remove('disabled');
        }

        function bukaQRIS() {
            modalVarianInstance.hide();
            trxData = {
                id: 'TRX' + new Date().getTime(),
                produk: produkAktif.nama,
                varian: varianPilihan.nama,
                harga: parseInt(varianPilihan.harga),
                status: 'PENDING',
                created: new Date().getTime(),
                expired: new Date().getTime() + (15 * 60 * 1000)
            };
            dbTransaksi = dbTransaksi.filter(t => t.status !== 'PENDING' || t.expired < new Date().getTime());
            dbTransaksi.push(trxData);
            localStorage.setItem('toko_trx', JSON.stringify(dbTransaksi));
            lanjutBayar(false);
        }
        
        function lanjutBayar(isResumed) {
            document.getElementById('qTotal').innerText = "Total: Rp " + trxData.harga.toLocaleString();
            document.getElementById('inputNama').value = isResumed ? (trxData.nama || "") : "";
            document.getElementById('inputWA').value = isResumed ? (trxData.wa || "") : "";
            document.getElementById('inputCatatan').value = isResumed ? (trxData.catatan || "") : "";
            

<!DOCTYPE html>
<html lang="id">
<head>
    <script>if (sessionStorage.getItem('statusLogin') !== 'SUKSES') { window.location.href = "login.html"; }</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AppSphere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f1219; color: #e0e6ed; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        .navbar-dark { background: #181b24 !important; border-bottom: 1px solid #232733; }
        .card { background: #1e222e; border: 1px solid #2a2f3d; margin-bottom: 20px; }
        .card-header { background: #232733; color: #4facfe; font-weight: bold; border-bottom: 1px solid #2a2f3d; }
        .form-control, .form-select { background: #13161c; border: 1px solid #2a2f3d; color: #ffffff; }
        .form-control:focus, .form-select:focus { background: #13161c; border-color: #4facfe; color: #ffffff; box-shadow: 0 0 5px rgba(79, 172, 254, 0.3); }
        .table { --bs-table-bg: transparent; --bs-table-color: #e0e6ed; border-color: #2a2f3d; }
        .table th { background-color: #232733; color: #4facfe; font-size: 13px; }
        .table td { font-size: 12px; vertical-align: middle; }
        .btn-primary { background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; font-weight: bold; }
        .nav-pills .nav-link.active { background: #4facfe; color: #000; font-weight: bold; }
        .nav-pills .nav-link { color: #a0aec0; }
        .upload-box { background: #13161c; border: 2px dashed #2a2f3d; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { border-color: #4facfe; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        const IMGBB_API_KEY = "d7ec6530cf6e558c2af55e645a091e6e"; // API KEY KAMU
        const firebaseConfig = {
          apiKey: "AIzaSyB-cU3n9GQiO5dyaXgLF3mwGFPZ6ACqQds",
          authDomain: "appsphere-de73d.firebaseapp.com",
          databaseURL: "https://appsphere-de73d-default-rtdb.firebaseio.com",
          projectId: "appsphere-de73d",
          storageBucket: "appsphere-de73d.firebasestorage.app",
          messagingSenderId: "610562583858",
          appId: "1:610562583858:web:7e252865c692af00783b2b",
          measurementId: "G-84ZR60FM03"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('produk');
        const dbTrans = firebase.database().ref('transaksi');
        const dbTesti = firebase.database().ref('testimoni'); // DATABASE BARU
    </script>
</head>
<body>
    <nav class="navbar navbar-dark mb-4 shadow-sm">
        <div class="container">
            <span class="navbar-brand fw-bold"><i class="fas fa-shield-alt me-2 text-primary"></i> ADMIN PANEL</span>
            <button onclick="logout()" class="btn btn-sm btn-danger"><i class="fas fa-sign-out-alt"></i> Keluar</button>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab">
            <li class="nav-item"><button class="nav-link active px-4" data-bs-toggle="pill" data-bs-target="#tab-produk"><i class="fas fa-box me-2"></i> PRODUK</button></li>
            <li class="nav-item"><button class="nav-link px-4" data-bs-toggle="pill" data-bs-target="#tab-pesanan"><i class="fas fa-shopping-cart me-2"></i> PESANAN</button></li>
            <li class="nav-item"><button class="nav-link px-4" data-bs-toggle="pill" data-bs-target="#tab-testi"><i class="fas fa-images me-2"></i> TESTIMONI</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-produk">
                <div class="alert alert-info small">Fitur Produk sama seperti sebelumnya. Gunakan form input.</div>
                </div>

            <div class="tab-pane fade" id="tab-pesanan">
                 <div class="card">
                    <div class="card-header d-flex justify-content-between"><span>Data Pesanan</span><button onclick="window.location.reload()" class="btn btn-sm btn-light">Refresh</button></div>
                    <div class="card-body p-0 table-responsive"><table class="table table-hover mb-0"><thead><tr><th>ID</th><th>Pembeli</th><th>Item</th><th>Aksi</th></tr></thead><tbody id="tabelPesanan"></tbody></table></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-testi">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header text-primary"><i class="fas fa-camera me-2"></i> Upload Testimoni</div>
                            <div class="card-body">
                                <div class="mb-3 text-center rounded p-3 upload-box" onclick="document.getElementById('fileSS').click()">
                                    <img id="previewSS" src="" style="max-height: 100px; display: none;" class="mx-auto d-block mb-2 shadow-sm rounded">
                                    <i id="iconUploadSS" class="fas fa-image fa-2x text-secondary"></i>
                                    <div class="small text-muted mt-1" id="statusUpload">Klik Upload SS</div>
                                </div>
                                <input type="file" id="fileSS" class="d-none" accept="image/*" onchange="uploadKeImgBB(this)">
                                <input type="hidden" id="urlSS"> <input type="text" id="tCaption" class="form-control mb-3" placeholder="Judul (Cth: Done Netflix)" required>
                                <button onclick="simpanTesti()" id="btnSimpanTesti" class="btn btn-primary w-100 btn-sm disabled">SIMPAN KE WEB</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">Galeri Testimoni Online</div>
                            <div class="card-body">
                                <div class="row g-2" id="listTesti"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // LOGIC TESTIMONI BARU (DATABASE ONLINE)
        dbTesti.on('value', (snapshot) => {
            const data = snapshot.val();
            let a = document.getElementById('listTesti'); a.innerHTML = "";
            if(data) {
                Object.keys(data).reverse().forEach(key => {
                    let ss = data[key];
                    a.innerHTML += `<div class="col-6 col-md-4"><div class="card border-0 shadow-sm"><img src="${ss.img}" class="card-img-top" style="height: 100px; object-fit: cover;"><div class="card-body p-2 bg-dark text-center"><small class="d-block text-truncate text-white mb-1" style="font-size:10px;">${ss.caption}</small><button onclick="hapusTesti('${key}')" class="btn btn-sm btn-outline-danger py-0 px-2" style="font-size:10px;">Hapus</button></div></div></div>`;
                });
            } else { a.innerHTML='<div class="text-center text-muted small p-3">Belum ada testimoni.</div>'; }
        });

        // 1. Upload ke ImgBB dulu
        function uploadKeImgBB(input) {
            let file = input.files[0];
            if(!file) return;
            document.getElementById('statusUpload').innerText = "Mengupload...";
            let formData = new FormData(); formData.append("image", file);
            
            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData })
            .then(res => res.json()).then(result => {
                if(result.success) {
                    document.getElementById('urlSS').value = result.data.url;
                    document.getElementById('previewSS').src = result.data.url;
                    document.getElementById('previewSS').style.display = 'block';
                    document.getElementById('iconUploadSS').style.display = 'none';
                    document.getElementById('statusUpload').innerText = "Sukses! Klik Simpan.";
                    document.getElementById('btnSimpanTesti').classList.remove('disabled');
                } else { alert("Gagal Upload Gambar"); }
            }).catch(e => alert("Error Koneksi"));
        }

        // 2. Simpan URL ke Firebase
        function simpanTesti() {
            let img = document.getElementById('urlSS').value;
            let cap = document.getElementById('tCaption').value;
            if(!img || !cap) return alert("Gambar/Judul kosong!");
            
            dbTesti.push({ img: img, caption: cap }).then(() => {
                alert("Testimoni Terbit!");
                document.getElementById('urlSS').value = "";
                document.getElementById('tCaption').value = "";
                document.getElementById('previewSS').style.display = 'none';
                document.getElementById('iconUploadSS').style.display = 'block';
                document.getElementById('statusUpload').innerText = "Upload Lagi";
                document.getElementById('fileSS').value = "";
            });
        }

        function hapusTesti(key) { if(confirm("Hapus?")) dbTesti.child(key).remove(); }

        // LOGIC PESANAN (Load Data)
        dbTrans.on('value', (s) => {
            let d = s.val(), t = document.getElementById('tabelPesanan'); t.innerHTML = "";
            if(d) { Object.keys(d).reverse().forEach(k => { let o = d[k]; t.innerHTML += `<tr><td><small>${o.id}</small></td><td>${o.nama}</td><td>${o.produk}</td><td><button onclick="firebase.database().ref('transaksi/${k}').remove()" class="btn btn-sm btn-danger px-2"><i class="fas fa-trash"></i></button></td></tr>`; }); }
        });

        function logout() { sessionStorage.removeItem('statusLogin'); window.location.href = "login.html"; }
    </script>
</body>
</html>
